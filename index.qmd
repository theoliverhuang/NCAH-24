---
title: NCAH Quantative Data Analysis
execute: 
  echo: false
---

```{r}
#| label: read-data-in
#| output: false
library(tidyverse)
library(janitor)
cep_2024 <- read_csv("data/2024_CEP_USDA_Annual Notification_NCDPI.csv") |> 
  mutate(year = 2024)

cep_2022 <- read_csv("data/2022_USDA CEP Annual Notification report_NCDPI.csv") |> 
  rename("Currently Participating in CEP in One or Some Schools (Not District-wide)" = "Currently Participating in CEP in One or Some Schools\n(Not District-wide)") |> 
  mutate(year = 2022) |> 
  rename(
    "identified_student_percentage_isp" = "Identified Student Percentage\r\n(ISP)"
  )

glimpse(cep_2024)
```

```{r}
#| label: cep-2023-read
#| output: false
cep_2023 <- read_csv("data/NCDPI CEP Notification - April 2023.csv") |> 
  mutate(year = 2023) |> 
    rename(
    "identified_student_percentage_isp" = "Identified Student Percentage\r\n(ISP)"
  )
glimpse(cep_2023)
```

```{r}
#| label: bind_rows
cep_all_raw <- cep_2024 |> 
  bind_rows(cep_2023, cep_2022) |> 
  clean_names() 
cep_all_raw
```

We edited the data to turn the column names into factors

```{r}
#| label: edit-data
#| output: false
cep_all <- cep_all_raw |> 
  mutate(
    identified_student_percentage_isp = str_remove(identified_student_percentage_isp, "[%]"),
    identified_student_percentage_isp_2 = str_remove(identified_student_percentage_isp_2, "[%]")
  ) |> 
  mutate(
    identified_student_percentage_isp = paste(identified_student_percentage_isp,
                                              identified_student_percentage_isp_2),
    identified_student_percentage_isp = str_remove(identified_student_percentage_isp, 
                                                   "NA"),
    identified_student_percentage_isp = as.double(identified_student_percentage_isp)
  ) |> 
  mutate(
    eligible_to_participate = case_when(
      eligible_to_participate == "X" ~ "eligible")
  ) |> 
  mutate(
    currently_participating_in_cep = case_when(
      currently_participating_in_cep == "X" ~ "participating",
      .default = "not participating"),
    currently_participating_in_cep = as.factor(currently_participating_in_cep)
  ) |> 
  mutate(
    participation_type = case_when(
      currently_participating_in_cep_district_wide == "A" ~ "District Wide",
      currently_participating_in_cep_in_one_or_some_schools_not_district_wide == "S" ~ "Some Schools",
      .default = "Not Participating"
    ),
    paticipation_type = fct_relevel(participation_type, "District Wide", "Some Schools", "Not Participating")
  ) |> 
  select(-x15, -identified_student_percentage_isp_2)
cep_all
```

# Changes in CEP Participation

CEP Participation has increased significantly across the past three years, especially between the 2023 to 2024 school year.

## Increases by District

District wide participation has increased from 58 to 111 schools.

```{r}
#| label: vis-cep-participation
cep_count_part <- cep_all |> 
  count(participation_type, year) |> 
  mutate(year = as.factor(year))

ggplot(cep_count_part,
       aes(x = year,
           y = n,
           color = participation_type,
           group = participation_type)) +
  geom_point() +
  geom_line() +
  labs(
    x = "Year",
    y = "Number of Schools",
    color = "Participation Status",
    group = "Participation Status",
    title = "Participation in CEP by District has Increased Dramatically",
    caption = "Source: NCDPI"
  ) +
  theme_minimal()

```

## Participation by eligibility

The higher the ISP, the more likely you are to participate in the Community Elibility Program
```{r}
cep_all |> 
  filter(year == 2024) |> 
  ggplot(aes(x = identified_student_percentage_isp, 
             fill = participation_type,
             color = participation_type)) +
  geom_histogram(alpha = .2) +
  geom_vline(xintercept = 25, alpha = .5) +
  geom_vline(xintercept = 62.5, alpha = .5) +
  labs(
    x = "Identified Student Percentage",
    y = "Number of Districts",
    title = "Participation and ISP Percentage"
  ) +
  theme_minimal()
```

